<!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>hyperxmail</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
        <style>
            :root {
                --bg-gradient-start: #101727;
                --bg-gradient-end: #2c3e50;
                --text-primary: #ecf0f1;
                --accent-primary: #3498db;
                --accent-secondary: #9b59b6;
                --accent-glow: rgba(52, 152, 219, 0.4);
                --container-bg: rgba(255, 255, 255, 0.08);
                --container-border: rgba(255, 255, 255, 0.2);
                --input-bg: rgba(0, 0, 0, 0.2);
                --input-border: rgba(52, 152, 219, 0.5);
                --success: #2ecc71;
                --error: #e74c3c;
                --disabled-bg: #566573;
                --font-family: 'Poppins', sans-serif;
            }
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: var(--font-family);
                background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                overflow-x: hidden;
                color: var(--text-primary);
            }
            #particles-js { position: fixed; width: 100%; height: 100%; z-index: -1; }
            .container {
                background: var(--container-bg);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid var(--container-border);
                border-radius: 16px;
                padding: 40px;
                width: 80%;
                max-width: 1400px;
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
                animation: fadeIn 0.8s ease-in-out;
                z-index: 1;
            }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            h1 {
                color: var(--text-primary);
                text-align: center;
                font-size: clamp(24px, 5vw, 28px);
                font-weight: 600;
                margin-bottom: 30px;
                letter-spacing: 1px;
            }
            input, textarea, select {
                width: 100%;
                padding: 15px;
                margin-bottom: 15px;
                background: var(--input-bg);
                border: 1px solid var(--container-border);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 16px;
                outline: none;
                transition: all 0.3s ease;
                font-family: var(--font-family);
            }
            input:focus, textarea:focus, select:focus {
                border-color: var(--accent-primary);
                box-shadow: 0 0 15px var(--accent-glow);
            }
            input.valid {
                background-color: rgba(46, 204, 113, 0.1) !important;
                border-color: var(--success) !important;
            }
            input.invalid {
                background-color: rgba(231, 76, 60, 0.1) !important;
                border-color: var(--error) !important;
            }
            textarea { height: 120px; resize: vertical; }
            button {
                width: 100%;
                padding: 15px;
                background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
                border: none;
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 16px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-top: 10px;
            }
            button:disabled {
                background: var(--disabled-bg);
                cursor: not-allowed;
                opacity: 0.6;
            }
            button:hover:not(:disabled) {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            }
            #progress-bar { width: 0; height: 4px; background-color: var(--accent-primary); border-radius: 2px; margin-top: 20px; transition: width 0.4s ease-in-out; }
            #status { text-align: center; margin-top: 20px; font-size: 15px; transition: opacity 0.3s ease; opacity: 0; height: 20px; }
            #status.active { opacity: 1; }
            #email-tags { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: var(--input-bg); border-radius: 8px; margin-bottom: 15px; }
            .tag { display: flex; align-items: center; background: var(--accent-primary); padding: 6px 12px; border-radius: 20px; color: var(--text-primary); font-size: 14px; }
            .tag.invalid { background: var(--error); }
            .tag button { all: unset; cursor: pointer; margin-left: 8px; font-size: 16px; line-height: 1; }
            #to-input { border: none; background: none; color: var(--text-primary); flex-grow: 1; min-width: 150px; padding: 0; margin: 0; }
            #log-area { margin-top: 20px; max-height: 150px; overflow-y: auto; background: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 15px; font-size: 13px; line-height: 1.6; }
            .log-success { color: var(--success); }
            .log-error { color: var(--error); }
            #attachment-input, #csv-input { display: none; }
            .file-input-label {
                display: block;
                padding: 15px;
                background: rgba(0,0,0,0.2);
                border-radius: 8px;
                text-align: center;
                cursor: pointer;
                margin-bottom: 15px;
                transition: background 0.3s ease;
            }
            .file-input-label:hover { background: rgba(0,0,0,0.3); }
            .template-bar { display: flex; gap: 10px; margin-bottom: 15px; }
            .template-bar select { margin: 0; }
            .template-bar button { width: auto; padding: 0 25px; margin: 0; font-size: 14px; background: var(--accent-secondary); }
            .button-group { display: flex; gap: 10px; margin-top: 20px; }
            .button-group button { width: 100%; margin: 0; }
            .feather { width: 18px; height: 18px; margin-right: 8px; vertical-align: middle; }
            .tag .feather { width: 14px; height: 14px; margin-right: 0; }
            .file-input-label .feather { margin-right: 10px; }
            button:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
            .tag { transition: transform 0.2s ease; }
            .file-input-label:hover { background: rgba(0,0,0,0.3); }
            #status.active { animation: fadeInOut 5s ease-in-out; }
            @keyframes fadeInOut {
                0%, 100% { opacity: 0; }
                10%, 90% { opacity: 1; }
            }

            /* Tablet */
            @media (max-width: 992px) {
                .container {
                    padding: 30px;
                }
            }

            /* Mobile */
            @media (max-width: 600px) {
                body {
                    align-items: flex-start;
                    padding-top: 20px;
                }
                .container {
                    padding: 20px;
                    width: 95%;
                    margin-bottom: 20px;
                }
                h1 { font-size: 22px; }
                input, textarea, select, button { font-size: 14px; padding: 12px; }
                .template-bar { flex-direction: column; }
                .button-group { flex-direction: column; }
            }

        </style>
        <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/8/tinymce.min.js" referrerpolicy="origin"></script>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script src="https://unpkg.com/feather-icons"></script>
        <script>
            tinymce.init({
                selector: 'textarea#message',
                plugins: 'code table lists image link',
                toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | code | table | image | link'
            });
        </script>
    </head>
    <body>
        <div id="particles-js"></div>
        <div class="container">
            <h1>hyperxmail</h1>
            <form id="emailForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div id="email-tags" aria-label="Destinatários">
                    <input type="text" id="to-input" placeholder="Add recipients and press Enter..." aria-label="Add recipient">
                </div>
                <input type="text" id="subject" placeholder="Subject" required aria-label="Subject">
                <input type="text" id="cc" placeholder="CC (comma separated)" aria-label="Carbon Copy">
                <input type="text" id="cco" placeholder="BCC (comma separated)" aria-label="Blind Carbon Copy">
                <div class="template-bar">
                    <select id="template-select" aria-label="Select Template">
                        <option value="">Load a Template</option>
                    </select>
                    <button type="button" id="save-template-button"><i data-feather="save"></i>Save Template</button>
                    <a href="/reports" class="button-link"><i data-feather="bar-chart-2"></i>Reports</a>
                </div>
                <style>
                    .button-link {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        padding: 0 25px;
                        font-size: 14px;
                        background: var(--accent-secondary);
                        color: var(--text-primary);
                        border-radius: 8px;
                        text-decoration: none;
                        transition: all 0.3s ease;
                        height: 50px;
                    }
                    .button-link:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
                    }
                </style>
                <textarea id="message" placeholder="Compose your message... (use <img> for images)" required minlength="5" aria-label="Message"></textarea>

                <label for="csv-input" class="file-input-label" id="csv-label"><i data-feather="upload-cloud"></i>Select CSV with emails (optional)</label>
                <input type="file" id="csv-input" accept=".csv" aria-label="Choose CSV with emails (optional)">

                <label for="attachment-input" class="file-input-label" id="attachment-label"><i data-feather="paperclip"></i>Attach Files (PDF, JPG, PNG)</label>
                <input type="file" id="attachment-input" multiple accept=".jpg,.jpeg,.png,.pdf" aria-label="Choose attachments">

                <div class="button-group">
                    <button type="button" id="preview-button"><i data-feather="eye"></i>Preview</button>
                    <button type="submit"><i data-feather="send"></i>Send Broadcast</button>
                </div>
                <div id="progress-bar"></div>
            </form>
            <p id="status"></p>
            <div id="log-area"></div>
        </div>

        <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
        <script>
            particlesJS('particles-js', {
                "particles": {
                    "number": { "value": 60, "density": { "enable": true, "value_area": 800 } },
                    "color": { "value": "#3498db" },
                    "shape": { "type": "circle" },
                    "opacity": { "value": 0.5, "random": true },
                    "size": { "value": 3, "random": true },
                    "line_linked": { "enable": false },
                    "move": { "enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out" }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" } },
                    "modes": { "repulse": { "distance": 100, "duration": 0.4 }, "push": { "particles_nb": 4 } }
                },
                "retina_detect": true
            });

            feather.replace();

            const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;

            function validateEmailList(input) {
                const emails = input.value.split(',').map(e => e.trim()).filter(e => e);
                if (emails.length === 0) {
                    input.classList.remove('valid', 'invalid');
                    return;
                }

                const allValid = emails.every(email => emailRegex.test(email));

                if (allValid) {
                    input.classList.add('valid');
                    input.classList.remove('invalid');
                } else {
                    input.classList.add('invalid');
                    input.classList.remove('valid');
                }
            }

            const toInput = document.getElementById('to-input');
            let emails = [];
            let attachmentCount = 0;
            let selectedCsvContent = '';

            function addTag(email) {
                if (email && !emails.includes(email)) {
                    const isValid = emailRegex.test(email);
                    const tag = document.createElement('div');
                    tag.className = `tag ${isValid ? '' : 'invalid'}`;
                    tag.innerHTML = `${email} <button type="button" aria-label="Remover"><i data-feather="x"></i></button>`;
                    tag.querySelector('button').onclick = () => {
                        emails = emails.filter(e => e !== email);
                        tag.remove();
                        log(`Destinatário removido: ${email}`);
                    };
                    emailTags.insertBefore(tag, toInput);
                    feather.replace();
                    emails.push(email);
                    log(`Destinatário adicionado: ${email} ${isValid ? '(válido)' : '(inválido)'}`);
                }
                toInput.value = '';
            }

            toInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    addTag(toInput.value.trim());
                }
            });

            const form = document.getElementById('emailForm');
            const status = document.getElementById('status');
            const button = form.querySelector('button[type="submit"]');
            const csvInput = document.getElementById('csv-input');
            const ccInput = document.getElementById('cc');
            const ccoInput = document.getElementById('cco');
            const attachmentInput = document.getElementById('attachment-input');
            const progressBar = document.getElementById('progress-bar');
            const logArea = document.getElementById('log-area');
            const previewButton = document.getElementById('preview-button');
            const emailTags = document.getElementById('email-tags');

            ccInput.addEventListener('input', () => validateEmailList(ccInput));
            ccoInput.addEventListener('input', () => validateEmailList(ccoInput));

            previewButton.addEventListener('click', () => {
                const content = tinymce.get('message').getContent();
                if (content) {
                    const previewWindow = window.open('', '_blank');
                    previewWindow.document.write(content);
                    previewWindow.document.close();
                    log("Pré-visualização gerada em nova aba.");
                } else {
                    showStatus("Nada para pré-visualizar.", false);
                    log("Tentativa de pré-visualizar com conteúdo vazio.", 'error');
                }
            });

            const saveTemplateButton = document.getElementById('save-template-button');
            const templateSelect = document.getElementById('template-select');
            let templates = [];

            async function loadTemplates() {
                try {
                    const response = await fetch('/templates');
                    if (!response.ok) throw new Error('Falha ao carregar templates');
                    templates = await response.json();

                    templateSelect.innerHTML = '<option value="">Carregar um Template</option>';
                    templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        templateSelect.appendChild(option);
                    });
                    log("Templates carregados com sucesso.");
                } catch (error) {
                    showStatus(error.message, false);
                    log(error.message, 'error');
                }
            }

            saveTemplateButton.addEventListener('click', async () => {
                const name = prompt("Digite o nome para este template:");
                if (!name || !name.trim()) {
                    showStatus("Nome do template inválido.", false);
                    return;
                }

                const content = tinymce.get('message').getContent();
                if (!content) {
                    showStatus("Não há conteúdo para salvar como template.", false);
                    return;
                }

                try {
                    const response = await fetch('/templates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('input[name="csrf_token"]').value
                        },
                        body: JSON.stringify({ name: name.trim(), content: content })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showStatus(result.message, true);
                        log(result.message, 'success');
                        loadTemplates(); // Recarrega a lista de templates
                    } else {
                        throw new Error(result.message || 'Erro desconhecido ao salvar template.');
                    }
                } catch (error) {
                    showStatus(error.message, false);
                    log(error.message, 'error');
                }
            });

            templateSelect.addEventListener('change', () => {
                const selectedId = templateSelect.value;
                if (selectedId) {
                    const selectedTemplate = templates.find(t => t.id === selectedId);
                    if (selectedTemplate) {
                        tinymce.get('message').setContent(selectedTemplate.content);
                        log(`Template "${selectedTemplate.name}" carregado.`);
                    }
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                loadTemplates();

                const socket = io();

                socket.on('connect', () => {
                    log('Conectado ao servidor de progresso.');
                });

                socket.on('progress', (data) => {
                    const percent = (data.sent / data.total) * 100;
                    progressBar.style.width = percent + '%';
                    log(`Email enviado para ${data.email} (${data.sent}/${data.total})`, 'success');
                });

                socket.on('task_error', (data) => {
                    showStatus(`Erro no envio: ${data.message}`, false);
                    log(`Erro no envio: ${data.message}`, 'error');
                    button.disabled = false;
                    button.textContent = "ENVIAR SINAL";
                });

                socket.on('disconnect', () => {
                    log('Desconectado do servidor de progresso.');
                });
            });

            function log(message, type = 'info') {
                const log = document.createElement('div');
                log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                log.className = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : '';
                logArea.appendChild(log);
                logArea.scrollTop = logArea.scrollHeight;
            }

            function showStatus(message, success) {
                status.textContent = message;
                status.style.color = success ? 'var(--success)' : 'var(--error)';
                status.classList.add('active');
                // A animação CSS cuida do fade out
                status.addEventListener('animationend', () => {
                    status.classList.remove('active');
                }, { once: true });
            }

            function checkFileSize(input) {
                const maxSize = 10 * 1024 * 1024;
                for (let file of input.files) {
                    if (file.size > maxSize) {
                        showStatus(`Erro: O arquivo ${file.name} excede o limite de 10MB.`, false);
                        log(`Arquivo ${file.name} excede o limite de tamanho.`, 'error');
                        input.value = '';
                        return false;
                    }
                }
                return true;
            }

            async function compressAndConvertFile(file) {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 800;

                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                        img.onload = () => {
                            const ratio = Math.min(maxWidth / img.width, 1);
                            canvas.width = img.width * ratio;
                            canvas.height = img.height * ratio;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                        };
                    };
                    reader.readAsDataURL(file);
                });
            }

            async function prepareAttachment(file) {
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                } else {
                    return compressAndConvertFile(file);
                }
            }

            csvInput.addEventListener('change', () => {
                const label = document.getElementById('csv-label');
                if (csvInput.files.length > 0) {
                    label.textContent = `CSV: ${csvInput.files[0].name}`;
                    const file = csvInput.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        selectedCsvContent = event.target.result;
                        log(`CSV selecionado: ${file.name}`, 'success');
                    };
                    reader.readAsText(file);
                } else {
                    label.textContent = 'Select CSV with emails (optional)';
                    selectedCsvContent = '';
                }
            });

            attachmentInput.addEventListener('change', () => {
                const label = document.getElementById('attachment-label');
                const files = attachmentInput.files;
                if (files.length > 0) {
                    label.textContent = `${files.length} file(s) selected`;
                } else {
                    label.textContent = 'Attach Files (PDF, JPG, PNG)';
                }

                if (files.length === 0) {
                    showStatus("Nenhum anexo selecionado.", false);
                    log("Nenhum anexo selecionado.", 'error');
                    return;
                }
                if (checkFileSize(attachmentInput)) {
                    const messageArea = document.getElementById('message');
                    let currentText = messageArea.value;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        if (file.name.toLowerCase().endsWith('.pdf')) {
                            currentText += `\nAnexo: ${file.name}\n`;
                        } else {
                            const cid = `image${attachmentCount + i}`;
                            const url = prompt("Digite a URL para o hyperlink da imagem (deixe em branco para não adicionar link):");
                            if (url && url.trim() !== "") {
                                currentText += `<a href="${url.trim()}" target="_blank"><img src="cid:${cid}" alt="${file.name}"></a>`;
                                log(`Imagem anexada com link para: ${url.trim()}`, 'success');
                            } else {
                                currentText += `<img src="cid:${cid}" alt="${file.name}">`;
                            }
                        }
                    }
                    messageArea.value = currentText;
                    attachmentCount += files.length;
                    log(`Adicionados ${files.length} anexo(s) ao texto.`, 'success');
                }
            });

            csvInput.addEventListener('change', () => {
                if (csvInput.files.length > 0) {
                    const file = csvInput.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        selectedCsvContent = event.target.result;
                        log(`CSV selecionado: ${file.name}`, 'success');
                    };
                    reader.readAsText(file);
                } else {
                    selectedCsvContent = '';
                }
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                tinymce.triggerSave(); // Salva o conteúdo do editor no textarea
                log("Iniciando processo de envio...");

                const subject = document.getElementById('subject').value.trim();
                const cc = document.getElementById('cc').value.trim();
                const cco = document.getElementById('cco').value.trim();
                const message = document.getElementById('message').value.trim();
                const attachmentFiles = attachmentInput.files;
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;

                if (!subject) {
                    showStatus("Erro: Assunto é obrigatório.", false);
                    log("Assunto não preenchido.", 'error');
                    return;
                }
                if (cc && !cc.split(',').every(email => emailRegex.test(email.trim()))) {
                    showStatus("Erro: CC inválido.", false);
                    log("CC inválido.", 'error');
                    return;
                }
                if (cco && !cco.split(',').every(email => emailRegex.test(email.trim()))) {
                    showStatus("Erro: CCO inválido.", false);
                    log("CCO inválido.", 'error');
                    return;
                }
                if (message.length < 5) {
                    showStatus("Erro: Mensagem muito curta.", false);
                    log("Mensagem muito curta.", 'error');
                    return;
                }
                if (!selectedCsvContent && emails.length === 0) {
                    showStatus("Erro: Nenhum destinatário ou CSV fornecido.", false);
                    log("Nenhum destinatário ou CSV fornecido.", 'error');
                    return;
                }

                const attachments = [];
                if (attachmentFiles.length > 0 && checkFileSize(attachmentInput)) {
                    log(`Preparando ${attachmentFiles.length} anexo(s)...`);
                    progressBar.style.width = '0%';
                    const filePromises = Array.from(attachmentFiles).map(async (file, index) => {
                        const base64Data = await prepareAttachment(file);
                        progressBar.style.width = `${((index + 1) / attachmentFiles.length) * 100}%`;
                        log(`Arquivo ${file.name} preparado.`);
                        return { name: file.name, data: base64Data };
                    });
                    attachments.push(...await Promise.all(filePromises));
                }

                button.disabled = true;
                button.textContent = "Transmitindo...";
                showStatus("", true);

                const payload = { 
                    subject: subject, 
                    cc: cc, 
                    bcc: cco, 
                    message: message, 
                    attachments: attachments, 
                    csvContent: selectedCsvContent,
                    manualEmails: emails 
                };

                try {
                    log("Enviando ao servidor...");
                    const response = await fetch('/send_email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (response.ok) {
                        showStatus(result.message, true);
                        log(`Sucesso: ${result.message}`, 'success');
                    } else {
                        showStatus(result.message || 'Erro desconhecido no servidor.', false);
                        log(`Erro: ${result.message || 'Resposta inválida do servidor.'}`, 'error');
                    }
                } catch (error) {
                    showStatus(`Erro na conexão: ${error.message}`, false);
                    log(`Erro na conexão: ${error.message}`, 'error');
                }

                button.disabled = false;
                button.textContent = "ENVIAR SINAL";
                progressBar.style.width = '0%';
                log("Processo concluído.");
            });
        </script>
    </body>
    </html>
